<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/app-route/app-location.html">

<link rel="import" href="mo-styles.html">
<link rel="import" href="mo-if.html">
<link rel="import" href="mo-jwt-request.html">

<dom-module id="mo-reset-password-view">
  <template>
    <style include="mo-styles">
      :host {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
      }

      paper-card {
        max-width: 100%;
        width: 20rem;
        height: 32rem;

        --paper-card-header: {
          transition: padding 0.25s ease-in-out;
          padding: 2.7rem 3rem 0;
        }
      }

      paper-card .card-actions {
        position: absolute;
        bottom: 0;
      }

      @media (max-width: 320px) {
        paper-card {
          --paper-card-header: {
            transition: padding 0.25s ease-in-out;
            padding: 0.5rem 0.5rem 0;
          }
        }
      }
    </style>

    <mo-jwt-request id="xhr"></mo-jwt-request>
    <app-location query-params="{{_queryParameters}}"></app-location>

    <iron-form>
      <form id="reset-password-form">
        <paper-card alt="Möjlighetsministeriet lösenordsåterställning" image="../assets/images/mojlighetsministeriet-224.png">
          <div class="card-content">
            <h1>Ange&nbsp;nytt lösenord</h1>
            <paper-input
              id="new-password"
              label="Nytt lösenord"
              name="password"
              type="password"
              autocomplete="password"
              auto-validate
              required
              on-keydown="_evaluatePasswordMismatch"
            ></paper-input>
            <paper-input
              id="new-password-repeat"
              label="Nytt lösenord igen"
              name="password-repeat"
              type="password"
              autocomplete="password"
              auto-validate
              required
              on-keydown="_evaluatePasswordMismatch"
            ></paper-input>
            <mo-if if="[[_showPasswordMismatchMessage]]">
              <p class="text-error">Lösenorden stämmer inte överrens!</p>
            </mo-if>
            <mo-if if="[[_showUnauthorizedMessage]]">
              <p class="text-error">Länken är för gammal, du behöver göra <a href="./">en ny återställning</a>.</p>
            </mo-if>
            <mo-if if="[[_showPasswordResetConfirmation]]">
              <p>Lösenordet är har ändrats, nu kan du <a href="./">logga in</a>.</p>
            </mo-if>
          </div>
          <div class="card-actions">
            <paper-button on-click="resetPassword">Återställ</paper-button>
          </div>
        </paper-card>
      </form>
    </iron-form>
  </template>

  <script>
    class MoResetPasswordView extends Polymer.Element {
      static get is() { return 'mo-reset-password-view'; }

      static get properties() {
        return {
          _showPasswordMismatchMessage: {
            type: Boolean,
            value: false
          },
          _showPasswordResetConfirmation: {
            type: Boolean,
            value: false
          },
          _showUnauthorizedMessage: {
            type: Boolean,
            value: false
          },
          _showPasswordResetError: {
            type: Boolean,
            value: false
          },
          _disableResetButton: {
            type: Boolean,
            value: false
          },
          _queryParameters: Object
        };
      }

      connectedCallback() {
        super.connectedCallback();

        setTimeout(() => {
          this.$['new-password'].focus();
        }, 0);
      }

      _hideBadUsernameOrPasswordMessage() {
        this.set('_showBadUsernameOrPasswordMessage', false);
      }

      _evaluatePasswordMismatch() {
        if (
          this.$['new-password-repeat'].value &&
          this.$['new-password'].value !== this.$['new-password-repeat'].value
        ) {
          this.set('_showPasswordMismatchMessage', true);
        } else if (this.$['new-password'].value === this.$['new-password-repeat'].value) {
          this.set('_showPasswordMismatchMessage', false);
        }
      }

      resetPassword() {
        // TODO: validate entire form here
        if (!this.$['new-password'].value) {
          return;
        }

        if (this.$['new-password'].value !== this.$['new-password-repeat'].value) {
          this.set('_showPasswordMismatchMessage', true);
          return;
        }

        this.$.xhr.send({
          url: '../api/identity-provider/account/reset-token/password',
          method: 'POST',
          json: true,
          body: {
            password: this.$['new-password'].value
          },
          token: this._queryParameters.token,
          skipDispatchUnauthorized: true
        }).then((response) => {
          this.set('_showPasswordResetConfirmation', true);
        }, (response) => {
          if (response.status === 401) {
            this.set('_showUnauthorizedMessage', true);
          } else if (response.status === 400) {
            this.set('_showBadRequestMessage', true);
            this.$['new-password'].focus();
          }
        });
      }
    }

    window.customElements.define(MoResetPasswordView.is, MoResetPasswordView);
  </script>
</dom-module>
