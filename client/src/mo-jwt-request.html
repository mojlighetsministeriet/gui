<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="mo-jwt-request">
  <script>
    class MoJWTRequest extends Polymer.Element {
      static get is() { return 'mo-jwt-request'; }

      send(options) {
        return new Promise((resolve, reject) => {
          let body = options.body;
          const token = options.token || window.localStorage.getItem('token');
          const xhr = new XMLHttpRequest();

          xhr.open(
            options.method && typeof options.method === 'string' ? options.method.toUpperCase() : 'GET',
            options.url,
            true
          );

          if (token) {
            xhr.setRequestHeader('Authorization', `Bearer ${token}`);
          }

          if (options.json) {
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('Accept', 'application/json');

            if (typeof body === 'object') {
              try {
                body = JSON.stringify(options.body);
              } catch (exception) {
                reject(exception);
                return;
              }
            }
          }

          xhr.onload = () => {
            let response = xhr.responseText;
            let error;

            if (options.json) {
              try {
                response = JSON.parse(response);
              } catch(exception) {
                error = exception;
              }
            }

            if (xhr.status < 200 || xhr.status > 299) {
              error = response;
              response = undefined;
            }

            if (xhr.status === 401 && !options.skipDispatchUnauthorized) {
              window.dispatchEvent(new CustomEvent('unauthenticated'));
            } else if (xhr.status === 404) {
              window.dispatchEvent(new CustomEvent('notfound', { detail: { url: options.url } }));
            } else if (xhr.status >= 500) {
              window.dispatchEvent(new CustomEvent('servererror'));
            }

            if (error) {
              reject({ status: xhr.status, body: error });
            } else {
              resolve({ status: xhr.status, body: response });
            }
          };

          xhr.onerror = () => {
            window.dispatchEvent(new CustomEvent('communicationerror'));
            reject(new Error('Unable to reach server'));
          };

          xhr.send(body);
        });
      }
    }

    window.customElements.define(MoJWTRequest.is, MoJWTRequest);
  </script>
</dom-module>
